---
suite: "Test K8s Secrets"
templates:
  - "secret.yaml"
release:
  name: "test"
  namespace: "test"
tests:

  - it: "Test Nautobot Env Secret"
    documentIndex: 0
    asserts:
      - equal:
          path: "metadata.name"
          value: "test-nautobot-env"
      - equal:
          path: "metadata.namespace"
          value: "test"
      - equal:
          path: "type"
          value: "Opaque"
      - exists:
          path: "data.NAUTOBOT_SECRET_KEY"
      - exists:
          path: "data.NAUTOBOT_SUPERUSER_API_TOKEN"
      - exists:
          path: "data.NAUTOBOT_SUPERUSER_PASSWORD"

  - it: "Test Nautobot Database Secret is not created when managed postgresql is used"
    set:
      postgresql:
        enabled: true
    asserts:
      - hasDocuments:
          count: 1

  - it: "Test Nautobot Database Secret is created when existing secret is used"
    set:
      nautobot:
        db:
          existingSecret: "test-postgresql"
    asserts:
      - hasDocuments:
          count: 1

  - it: "Test Nautobot Database Secret is created"
    documentIndex: 1
    set:
      postgresql:
        enabled: false
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: "metadata.name"
          value: "test-nautobot-db"
      - exists:
          path: "data.username"
      - exists:
          path: "data.password"
